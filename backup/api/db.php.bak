<?php
/**
 * DÃ©boucheur Expert - Enhanced Database Connection Helper
 * Supports: deboucheur_prod, deboucheur_test, deboucheur_dev
 * Host: Namecheap cPanel MySQL
 */

if (!defined('DB_ACCESS')) {
    define('DB_ACCESS', true);
}

define('DB_HOST', 'localhost');
define('DB_USER', 'deboucheur_shurukn');
define('DB_PASS', 'Christina4032');
define('DB_CHARSET', 'utf8mb4');

function get_db_connection(string $env = 'prod'): mysqli {
    $databases = [
        'prod' => 'deboucheur_prod',
        'test' => 'deboucheur_test',
        'dev'  => 'deboucheur_dev'
    ];
    
    $db = $databases[$env] ?? $databases['prod'];
    $mysqli = new mysqli(DB_HOST, DB_USER, DB_PASS, $db);
    
    if ($mysqli->connect_errno) {
        error_log("Database connection failed: " . $mysqli->connect_error);
        http_response_code(500);
        die(json_encode(['error' => 'Database connection failed', 'code' => 'DB_CONN_ERROR']));
    }
    
    $mysqli->set_charset(DB_CHARSET);
    $mysqli->query("SET time_zone = '-05:00'");
    return $mysqli;
}

function db_prepare(mysqli $db, string $sql, string $types = '', array $params = []) {
    $stmt = $db->prepare($sql);
    if (!$stmt) { error_log("Prepare failed: " . $db->error); return false; }
    if (!empty($params) && !empty($types)) { $stmt->bind_param($types, ...$params); }
    return $stmt;
}

function db_query(mysqli $db, string $sql, string $types = '', array $params = []) {
    $stmt = db_prepare($db, $sql, $types, $params);
    if (!$stmt) { return false; }
    if (!$stmt->execute()) { error_log("Execute failed: " . $stmt->error); return false; }
    $result = $stmt->get_result();
    if ($result === false) {
        return ['affected_rows' => $stmt->affected_rows, 'insert_id' => $stmt->insert_id];
    }
    $rows = [];
    while ($row = $result->fetch_assoc()) { $rows[] = $row; }
    $stmt->close();
    return $rows;
}

function db_insert(mysqli $db, string $table, array $data) {
    $columns = array_keys($data);
    $values = array_values($data);
    $placeholders = str_repeat('?,', count($values) - 1) . '?';
    $types = str_repeat('s', count($values));
    $sql = "INSERT INTO `{$table}` (`" . implode('`,`', $columns) . "`) VALUES ({$placeholders})";
    $result = db_query($db, $sql, $types, $values);
    return $result ? $result['insert_id'] : false;
}

function db_update(mysqli $db, string $table, array $data, string $where, string $types = '', array $whereParams = []) {
    $sets = []; $values = []; $paramTypes = '';
    foreach ($data as $col => $val) { $sets[] = "`{$col}` = ?"; $values[] = $val; $paramTypes .= 's'; }
    $sql = "UPDATE `{$table}` SET " . implode(', ', $sets) . " WHERE {$where}";
    $result = db_query($db, $sql, $paramTypes . $types, array_merge($values, $whereParams));
    return $result ? $result['affected_rows'] : false;
}

function db_escape(mysqli $db, $input): string {
    return is_null($input) ? 'NULL' : $db->real_escape_string(trim($input));
}

function db_begin(mysqli $db): bool { return $db->begin_transaction(); }
function db_commit(mysqli $db): bool { return $db->commit(); }
function db_rollback(mysqli $db): bool { return $db->rollback(); }
function db_close(mysqli $db): void { $db->close(); }
