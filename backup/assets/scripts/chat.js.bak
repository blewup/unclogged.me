/**
 * D√©boucheur Expert - AI Chat Module
 * Handles the L'Apprenti chatbot functionality
 */

const ChatConfig = {
    apiKey: '', // Add your Gemini API key
    model: 'gemini-2.5-flash-preview-09-2025',
    systemPrompt: `Tu es 'L'Apprenti de Billy', l'assistant virtuel de D√©boucheur Expert, une entreprise de plomberie √† Montr√©al et en Mont√©r√©gie.

Ton r√¥le:
- Aider les visiteurs avec des questions sur la plomberie
- Diagnostiquer des probl√®mes de plomberie √† partir de descriptions ou de photos
- Expliquer les services offerts par Billy St-Hilaire
- Encourager les visiteurs √† appeler le 514-972-2078 pour une urgence ou pour prendre rendez-vous

Services offerts:
- D√©bouchage (√©gouts, lavabos, toilettes)
- Inspection par cam√©ra HD
- R√©novation de salles de bain et cuisines
- R√©paration de fuites
- Service d'urgence 24/7

Zones desservies: Montr√©al et Mont√©r√©gie (Rive-Sud principalement)

R√©ponds en fran√ßais par d√©faut, mais tu peux r√©pondre en anglais si le visiteur √©crit en anglais.
Sois professionnel, amical et serviable. Encourage toujours l'action (appeler, prendre RDV).`
};

let uploadedImageBase64 = null;

function toggleChat() {
    const widget = document.getElementById('ai-chat-widget');
    if (widget) {
        widget.classList.toggle('hidden-widget');
        
        // Track event
        if (window.DeboucheurApp?.trackEvent) {
            window.DeboucheurApp.trackEvent('chat_toggle', { 
                open: !widget.classList.contains('hidden-widget') 
            });
        }
    }
}

function handleImageUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    document.getElementById('file-name').innerText = file.name;
    
    const reader = new FileReader();
    reader.onloadend = () => {
        uploadedImageBase64 = reader.result.split(',')[1];
        
        const messagesDiv = document.getElementById('chat-messages');
        messagesDiv.innerHTML += `
            <div class="user-msg">
                <img src="${reader.result}" class="max-w-[150px] rounded-lg border border-white/20">
            </div>
        `;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    };
    reader.readAsDataURL(file);
}

async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    const messagesDiv = document.getElementById('chat-messages');
    
    if (!message && !uploadedImageBase64) return;
    
    // Display user message
    if (message) {
        messagesDiv.innerHTML += `<div class="user-msg">${escapeHtml(message)}</div>`;
    }
    
    input.value = '';
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    // Show loading indicator
    const loadingId = 'loading-' + Date.now();
    messagesDiv.innerHTML += `
        <div id="${loadingId}" class="ai-msg">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
        </div>
    `;
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    // Track event
    if (window.DeboucheurApp?.trackEvent) {
        window.DeboucheurApp.trackEvent('chat_message', { 
            hasImage: !!uploadedImageBase64,
            messageLength: message.length
        });
    }
    
    // Prepare request parts
    const parts = [];
    if (message) parts.push({ text: message });
    if (uploadedImageBase64) {
        parts.push({ 
            inlineData: { 
                mimeType: "image/jpeg", 
                data: uploadedImageBase64 
            } 
        });
        uploadedImageBase64 = null;
        document.getElementById('file-name').innerText = "";
    }
    
    // Check for API key
    if (!ChatConfig.apiKey) {
        document.getElementById(loadingId).remove();
        messagesDiv.innerHTML += `
            <div class="ai-msg">
                Je suis d√©sol√©, le service de chat n'est pas configur√© pour le moment. 
                Pour obtenir de l'aide imm√©diate, appelez Billy au 
                <a href="tel:+15149722078" class="text-websiteBlue font-bold">514-972-2078</a>! üîß
            </div>
        `;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return;
    }
    
    try {
        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/${ChatConfig.model}:generateContent?key=${ChatConfig.apiKey}`,
            {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts }],
                    systemInstruction: { parts: [{ text: ChatConfig.systemPrompt }] }
                })
            }
        );
        
        const data = await response.json();
        const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 
            "Je suis d√©sol√©, je n'ai pas pu traiter votre demande. Veuillez appeler le 514-972-2078 pour assistance.";
        
        document.getElementById(loadingId).remove();
        messagesDiv.innerHTML += `<div class="ai-msg">${formatChatResponse(aiResponse)}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
    } catch (error) {
        console.error('Chat error:', error);
        document.getElementById(loadingId).remove();
        messagesDiv.innerHTML += `
            <div class="ai-msg">
                Erreur de connexion. Pour une assistance imm√©diate, 
                appelez le <a href="tel:+15149722078" class="text-websiteBlue font-bold">514-972-2078</a>
            </div>
        `;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatChatResponse(text) {
    // Convert markdown-style formatting
    return text
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/(514-972-2078)/g, '<a href="tel:+15149722078" class="text-websiteBlue font-bold">$1</a>');
}

// Initialize chat with Enter key support
document.addEventListener('DOMContentLoaded', () => {
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    }
});

// Export for global access
window.ChatModule = {
    toggleChat,
    handleImageUpload,
    sendMessage
};
