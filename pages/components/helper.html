<!--
    AI HELPER WIDGET COMPONENT - D√©boucheur Expert
    Chat assistant powered by Google Gemini AI with SMS/Email conversation forwarding
    
    Features:
    - Real-time AI responses for plumbing questions
    - Image upload for problem diagnosis
    - Conversation forwarding to owner via SMS and email
    - Owner responses displayed as "Billy" in chat
    - 0-12 hour response time for owner replies
    
    Usage: Include this component at the end of <body>
-->

<!-- L'APPRENTI FLOATING BUTTON -->
<button id="helper-toggle-btn" class="fixed bottom-[2%] right-[2%] z-[70] bg-websiteBlue hover:bg-blue-600 text-white rounded-full shadow-2xl p-0 transition-transform hover:scale-110 border-2 border-white animate-bounce-slow flex items-center justify-center overflow-hidden" style="width: 80px; height: 80px;">
    <img src="" alt="L'Apprenti" class="w-full h-full object-cover" id="helper-logo-img">
</button>

<!-- AI CHAT WIDGET -->
<div id="ai-chat-widget" class="fixed bottom-[12%] right-[5%] z-[80] w-80 md:w-96 bg-gray-900 border border-gray-700 box-radius shadow-2xl overflow-hidden flex flex-col hidden-widget" style="height: 500px; max-height: 70vh;">
    <div class="bg-websiteBlue p-4 flex justify-between items-center border-b border-blue-600">
        <div class="flex items-center gap-2">
            <svg class="w-6 h-6 text-white" viewBox="0 0 640 512" fill="currentColor"><path d="M320 0c17.7 0 32 14.3 32 32V96H472c39.8 0 72 32.2 72 72V440c0 39.8-32.2 72-72 72H168c-39.8 0-72-32.2-72-72V168c0-39.8 32.2-72 72-72H288V32c0-17.7 14.3-32 32-32zM208 384c-8.8 0-16 7.2-16 16s7.2 16 16 16h32c8.8 0 16-7.2 16-16s-7.2-16-16-16H208zm96 0c-8.8 0-16 7.2-16 16s7.2 16 16 16h32c8.8 0 16-7.2 16-16s-7.2-16-16-16H304zm96 0c-8.8 0-16 7.2-16 16s7.2 16 16 16h32c8.8 0 16-7.2 16-16s-7.2-16-16-16H400zM264 256a40 40 0 1 0 -80 0 40 40 0 1 0 80 0zm152 40a40 40 0 1 0 0-80 40 40 0 1 0 0 80zM48 224H64V416H48c-26.5 0-48-21.5-48-48V272c0-26.5 21.5-48 48-48zm544 0c26.5 0 48 21.5 48 48v96c0 26.5-21.5 48-48 48H576V224h16z"/></svg>
            <div>
                <h4 class="font-ops text-white text-sm">Apprenti D√©boucheur</h4>
                <p class="text-xs text-blue-100 font-playfair">Assistant IA & Diagnostic</p>
            </div>
        </div>
        <button id="helper-close-btn" class="text-white hover:text-gray-200">
            <svg class="w-5 h-5" viewBox="0 0 384 512" fill="currentColor"><path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/></svg>
        </button>
    </div>
    <div id="chat-messages" class="flex-grow overflow-y-auto p-4 flex flex-col gap-2 bg-gray-800 scrollbar-thin">
        <div class="ai-msg font-playfair">Bonjour! Je suis l'assistant virtuel de Billy. Je peux r√©pondre √† vos questions ou analyser une photo de votre probl√®me de plomberie! üõ†Ô∏èüì∏</div>
    </div>
    <div class="p-3 bg-gray-900 border-t border-gray-700">
        <div class="flex items-center gap-2 mb-2">
            <label for="helper-image-upload" class="cursor-pointer text-gray-400 hover:text-websiteBlue transition p-2">
                <svg class="w-5 h-5" viewBox="0 0 512 512" fill="currentColor"><path d="M149.1 64.8L138.7 96H64C28.7 96 0 124.7 0 160V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H373.3L362.9 64.8C356.4 45.2 338.1 32 317.4 32H194.6c-20.7 0-39 13.2-45.5 32.8zM256 192a96 96 0 1 1 0 192 96 96 0 1 1 0-192z"/></svg>
            </label>
            <input type="file" id="helper-image-upload" accept="image/*" class="hidden">
            <span id="helper-file-name" class="text-xs text-gray-500 truncate max-w-[100px] font-inter"></span>
        </div>
        <div class="flex gap-2">
            <input type="text" id="chat-input" placeholder="Posez une question..." class="flex-grow bg-gray-800 text-white border border-gray-600 box-radius px-3 py-2 text-sm focus:border-websiteBlue outline-none font-playfair">
            <button id="helper-send-btn" class="bg-websiteBlue hover:bg-blue-600 text-white p-2 box-radius transition">
                <svg class="w-4 h-4" viewBox="0 0 512 512" fill="currentColor"><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 googl 493.4 256 512c0-12.6-7.4-24-18.9-29.2L48 256 57.5 232.1C63.9 215 80.1 203.6 98.3 201.9L256 224 416 64z"/></svg>
            </button>
        </div>
    </div>
</div>

<script>
(function() {
    // Configuration
    const CONFIG = {
        apiKey: 'AIzaSyCShzljUGrqSmhLDisfdliIitd9cXFRQZ0',
        model: 'gemini-2.5-flash-preview-09-2025',
        ownerPhone: '+14385302343',
        ownerEmail: 'info@deboucheur.expert',
        responseTime: '0-12 heures'
    };

    const SYSTEM_PROMPT = `Tu es 'L'Apprenti de Billy', un assistant virtuel expert en plomberie r√©sidentielle pour Billy St-Hilaire, D√©boucheur Expert bas√© √† Montr√©al et Mont√©r√©gie.

SERVICES ET TARIFS:
- D√©bouchage: 200-640$/h selon complexit√©
- R√©novation plomberie (salle de bain, cuisine)
- Inspection cam√©ra HD avec rapport d√©taill√©
- Urgences 24/7 disponibles

OUTILS PROFESSIONNELS:
- Furet √©lectrique professionnel
- Hydrocureur haute pression
- Cam√©ra d'inspection HD
- √âquipement de soudure (MIG, TIG, SMAW)

D√âLAIS DE R√âPONSE:
- SMS: 0-12 heures
- Messagerie vocale: 12-24 heures
- Courriel: 24-48 heures

COMPORTEMENT:
- Sois amical et professionnel
- R√©ponds en fran√ßais par d√©faut, en anglais si demand√©
- Pour les urgences, incite √† appeler (438) 530-2343
- Dirige vers unclogged.me ou deboucheur.expert pour plus d'infos
- Si une photo est envoy√©e, analyse le probl√®me de plomberie visible
- Ne donne pas de conseils dangereux (√©lectricit√©, gaz)
- Si le client a besoin d'une r√©ponse personnalis√©e, informe-le que Billy r√©pondra dans les 0-12 heures`;

    // State
    let uploadedImageBase64 = null;
    let conversationHistory = [];
    let sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    // Determine paths based on page location
    const isIndexPage = window.location.pathname.endsWith('index.html') || 
                        window.location.pathname.endsWith('/') ||
                        window.location.pathname === '';
    const apiBasePath = isIndexPage ? 'api/' : '../api/';
    const assetsBasePath = isIndexPage ? 'assets/' : '../assets/';

    // Set logo image path
    const logoImg = document.getElementById('helper-logo-img');
    if (logoImg) {
        logoImg.src = assetsBasePath + 'images/logo/logo.png';
    }

    // DOM elements
    const toggleBtn = document.getElementById('helper-toggle-btn');
    const closeBtn = document.getElementById('helper-close-btn');
    const widget = document.getElementById('ai-chat-widget');
    const messagesDiv = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('helper-send-btn');
    const imageUpload = document.getElementById('helper-image-upload');
    const fileName = document.getElementById('helper-file-name');

    // Toggle chat widget
    function toggleChat() {
        if (widget) {
            widget.classList.toggle('hidden-widget');
            if (!widget.classList.contains('hidden-widget') && chatInput) {
                setTimeout(() => chatInput.focus(), 100);
            }
        }
    }

    // Event listeners
    if (toggleBtn) toggleBtn.addEventListener('click', toggleChat);
    if (closeBtn) closeBtn.addEventListener('click', toggleChat);
    if (sendBtn) sendBtn.addEventListener('click', sendMessage);
    if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    }
    if (imageUpload) {
        imageUpload.addEventListener('change', handleImageUpload);
    }

    // Handle image upload
    function handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (fileName) fileName.innerText = file.name;
        
        const reader = new FileReader();
        reader.onloadend = () => {
            uploadedImageBase64 = reader.result.split(',')[1];
            addMessage(`<img src="${reader.result}" class="max-w-[150px] rounded-lg border border-white/20">`, 'user');
        };
        reader.readAsDataURL(file);
    }

    // Add message to chat
    function addMessage(content, type = 'ai') {
        if (!messagesDiv) return;
        
        const msgDiv = document.createElement('div');
        msgDiv.className = type === 'user' ? 'user-msg' : 
                           type === 'owner' ? 'owner-msg bg-green-800/50 text-white p-3 rounded-lg border-l-4 border-green-500' : 
                           'ai-msg';
        msgDiv.innerHTML = content;
        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Send message to AI and forward to owner
    async function sendMessage() {
        const message = chatInput ? chatInput.value.trim() : '';
        if (!message && !uploadedImageBase64) return;

        // Add user message to chat
        if (message) {
            addMessage(message, 'user');
            chatInput.value = '';
        }

        // Store in conversation history
        conversationHistory.push({
            role: 'user',
            content: message,
            timestamp: new Date().toISOString(),
            hasImage: !!uploadedImageBase64
        });

        // Show typing indicator
        const loadingId = 'loading-' + Date.now();
        const loadingDiv = document.createElement('div');
        loadingDiv.id = loadingId;
        loadingDiv.className = 'ai-msg';
        loadingDiv.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
        messagesDiv.appendChild(loadingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Prepare API request
        const parts = [];
        if (message) parts.push({ text: message });
        if (uploadedImageBase64) {
            parts.push({ inlineData: { mimeType: "image/jpeg", data: uploadedImageBase64 } });
            uploadedImageBase64 = null;
            if (fileName) fileName.innerText = '';
        }

        try {
            // Call Gemini API
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.model}:generateContent?key=${CONFIG.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: parts }],
                    systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] }
                })
            });

            const data = await response.json();
            const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "Erreur d'analyse.";

            // Remove loading indicator and show response
            const loader = document.getElementById(loadingId);
            if (loader) loader.remove();
            
            addMessage(aiResponse.replace(/\n/g, '<br>'), 'ai');

            // Store AI response in history
            conversationHistory.push({
                role: 'assistant',
                content: aiResponse,
                timestamp: new Date().toISOString()
            });

            // Forward conversation to owner via backend
            await forwardToOwner(message, aiResponse);

        } catch (error) {
            const loader = document.getElementById(loadingId);
            if (loader) loader.remove();
            addMessage('Erreur de connexion. Veuillez appeler le (438) 530-2343 pour assistance.', 'ai');
        }
    }

    // Forward conversation to owner via SMS and email
    async function forwardToOwner(userMessage, aiResponse) {
        try {
            await fetch(apiBasePath + 'chat-forward.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sessionId: sessionId,
                    userMessage: userMessage,
                    aiResponse: aiResponse,
                    conversationHistory: conversationHistory,
                    timestamp: new Date().toISOString(),
                    pageUrl: window.location.href
                })
            });
        } catch (error) {
            console.log('Forward failed, continuing conversation locally');
        }
    }

    // Poll for owner responses
    async function checkOwnerResponses() {
        try {
            const response = await fetch(apiBasePath + 'chat-responses.php?sessionId=' + sessionId);
            const data = await response.json();
            
            if (data.responses && data.responses.length > 0) {
                data.responses.forEach(resp => {
                    addMessage(`<strong class="text-green-400">Billy:</strong> ${resp.message}`, 'owner');
                    conversationHistory.push({
                        role: 'owner',
                        content: resp.message,
                        timestamp: resp.timestamp
                    });
                });
            }
        } catch (error) {
            // Silent fail for polling
        }
    }

    // Poll every 30 seconds for owner responses
    setInterval(checkOwnerResponses, 30000);

    // Expose for external use
    window.HelperWidget = { toggleChat, sendMessage };
})();
</script>

<style>
.hidden-widget {
    transform: translateX(150%) scale(0.8);
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease-in-out;
}

#ai-chat-widget {
    transition: all 0.3s ease-in-out;
}

.user-msg {
    background: linear-gradient(135deg, #2563EB 0%, #1d4ed8 100%);
    color: white;
    padding: 0.75rem 1rem;
    border-radius: 1rem 1rem 0.25rem 1rem;
    max-width: 85%;
    align-self: flex-end;
    word-wrap: break-word;
}

.ai-msg {
    background: #374151;
    color: #e5e7eb;
    padding: 0.75rem 1rem;
    border-radius: 1rem 1rem 1rem 0.25rem;
    max-width: 85%;
    align-self: flex-start;
    word-wrap: break-word;
}

.owner-msg {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: white;
    padding: 0.75rem 1rem;
    border-radius: 1rem 1rem 1rem 0.25rem;
    max-width: 85%;
    align-self: flex-start;
    word-wrap: break-word;
    border-left: 4px solid #15803d;
}

.typing-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    background: #9ca3af;
    border-radius: 50%;
    margin: 0 2px;
    animation: typing-bounce 1.4s infinite ease-in-out both;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
.typing-dot:nth-child(3) { animation-delay: 0s; }

@keyframes typing-bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

.animate-bounce-slow {
    animation: bounce 3s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(-10%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
    50% { transform: translateY(0); animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
}
</style>
