# =============================================================================
# DÃ©boucheur Expert - GitHub Actions CI/CD Pipeline
# Static HTML/CSS/JS + PHP Backend Deployment
# =============================================================================
# This workflow validates, tests, and deploys the unclogged.me website
# to Namecheap cPanel hosting via FTP/SFTP
# =============================================================================

name: Deploy DÃ©boucheur Expert

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# Prevent concurrent deployments
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'

jobs:
  # ===========================================================================
  # JOB 1: Validate & Lint
  # ===========================================================================
  validate:
    name: ğŸ” Validate Code
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mysqli, mbstring, json, curl
          tools: composer:v2
          coverage: none

      - name: ğŸ” PHP Syntax Check
        run: |
          echo "ğŸ” Checking PHP syntax..."
          SYNTAX_ERRORS=0
          while IFS= read -r file; do
            if ! php -l "$file" > /dev/null 2>&1; then
              echo "âŒ Syntax error in: $file"
              php -l "$file"
              SYNTAX_ERRORS=$((SYNTAX_ERRORS + 1))
            fi
          done < <(find . -name "*.php" -not -path "./vendor/*" -not -path "./backup/*")
          
          if [ "$SYNTAX_ERRORS" -gt 0 ]; then
            echo "âŒ Found $SYNTAX_ERRORS PHP file(s) with syntax errors"
            exit 1
          fi
          echo "âœ… All PHP files passed syntax validation"

      - name: ğŸ“‹ Validate JSON files
        run: |
          echo "ğŸ” Validating JSON files..."
          for file in manifest.json site.manifest; do
            if [ -f "$file" ]; then
              echo "  Checking $file..."
              python3 -m json.tool "$file" > /dev/null && echo "    âœ… $file is valid"
            fi
          done

      - name: ğŸŒ Validate HTML structure
        run: |
          echo "ğŸ” Checking HTML files..."
          HTML_COUNT=$(find . -name "*.html" -not -path "./backup/*" -not -path "./node_modules/*" | wc -l)
          echo "  Found $HTML_COUNT HTML files"
          # Check for common issues
          echo "  Checking for unclosed tags..."
          find . -name "*.html" -not -path "./backup/*" -exec grep -l "<script.*>" {} \; | head -5
          echo "âœ… HTML validation complete"

      - name: ğŸ¨ Check CSS files exist
        run: |
          echo "ğŸ” Verifying stylesheets..."
          ls -la assets/styles/*.css | head -10
          echo "âœ… Stylesheets verified"

      - name: ğŸ“œ Check JavaScript files
        run: |
          echo "ğŸ” Verifying JavaScript files..."
          ls -la assets/scripts/*.js | head -15
          echo "âœ… JavaScript files verified"

  # ===========================================================================
  # JOB 2: Security Scan
  # ===========================================================================
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Check for sensitive data
        run: |
          echo "ğŸ” Scanning for sensitive data patterns..."
          # Check for exposed API keys (excluding expected config patterns)
          if grep -rn "AIza[0-9A-Za-z_-]\{35\}" --include="*.html" --include="*.js" . 2>/dev/null | grep -v "backup/"; then
            echo "âš ï¸ Warning: Possible API key found in source files"
          fi
          # Check for hardcoded passwords (excluding db.php which is expected)
          if grep -rn "password\s*=\s*['\"]" --include="*.php" . 2>/dev/null | grep -v "backup/" | grep -v "db.php"; then
            echo "âš ï¸ Warning: Possible hardcoded password found"
          fi
          echo "âœ… Security scan complete"

      - name: ğŸ›¡ï¸ Check file permissions
        run: |
          echo "ğŸ” Checking for insecure file permissions..."
          find . -type f -name "*.php" -not -path "./backup/*" -exec ls -la {} \; | head -10
          echo "âœ… Permission check complete"

  # ===========================================================================
  # JOB 3: Build & Optimize
  # ===========================================================================
  build:
    name: ğŸ—ï¸ Build & Optimize
    runs-on: ubuntu-latest
    needs: [validate, security]
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Create deployment package
        run: |
          echo "ğŸ“¦ Preparing deployment package..."
          mkdir -p dist
          
          # Copy all necessary files (exclude dev/backup files)
          rsync -av --progress \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='backup' \
            --exclude='*.bak' \
            --exclude='*.txt' \
            --exclude='README.md' \
            --exclude='LICENSE' \
            --exclude='.gitignore' \
            --exclude='dist' \
            --exclude='node_modules' \
            . dist/
          
          echo "âœ… Deployment package created"

      - name: ğŸ“Š Package summary
        run: |
          echo "ğŸ“Š Deployment package contents:"
          echo "  HTML files: $(find dist -name '*.html' | wc -l)"
          echo "  CSS files: $(find dist -name '*.css' | wc -l)"
          echo "  JS files: $(find dist -name '*.js' | wc -l)"
          echo "  PHP files: $(find dist -name '*.php' | wc -l)"
          echo "  Images: $(find dist -name '*.webp' -o -name '*.png' -o -name '*.jpg' | wc -l)"
          echo "  Total size: $(du -sh dist | cut -f1)"

      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-build
          path: dist/
          retention-days: 7

  # ===========================================================================
  # JOB 4: Deploy to Production
  # ===========================================================================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://unclogged.me
    
    steps:
      - name: ğŸ“¥ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: website-build
          path: dist/

      - name: ğŸ”§ Prepare deployment
        run: |
          echo "ğŸ”§ Preparing for deployment..."
          # Update cache version in service worker
          sed -i "s/deboucheur-cache-v[0-9]*/deboucheur-cache-v$(date +%s)/" dist/service-worker.js || true
          echo "âœ… Deployment prepared"

      - name: ğŸš€ Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          exclude: |
            **/.git*
            **/.git*/**
            **/backup/**
            **/*.bak
            **/*.txt
            **/README.md
            **/LICENSE

      - name: âœ… Deployment complete
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo "ğŸŒ Website: https://unclogged.me"
          echo "ğŸŒ Alt URL: https://deboucheur.expert"
          echo "ğŸ“… Deployed: $(date)"

  # ===========================================================================
  # JOB 5: Post-Deploy Verification
  # ===========================================================================
  verify:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸŒ Check website availability
        run: |
          echo "ğŸ” Verifying deployment..."
          
          # Check main site
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://unclogged.me || echo "000")
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… unclogged.me is online (HTTP $HTTP_STATUS)"
          else
            echo "âš ï¸ unclogged.me returned HTTP $HTTP_STATUS"
          fi
          
          # Check alternate domain
          HTTP_STATUS_FR=$(curl -s -o /dev/null -w "%{http_code}" https://deboucheur.expert || echo "000")
          if [ "$HTTP_STATUS_FR" = "200" ]; then
            echo "âœ… deboucheur.expert is online (HTTP $HTTP_STATUS_FR)"
          else
            echo "âš ï¸ deboucheur.expert returned HTTP $HTTP_STATUS_FR"
          fi

      - name: ğŸ“± Check PWA manifest
        run: |
          echo "ğŸ” Verifying PWA manifest..."
          curl -s https://unclogged.me/manifest.json | python3 -m json.tool > /dev/null && \
            echo "âœ… PWA manifest is valid" || echo "âš ï¸ PWA manifest check failed"

      - name: ğŸ”” Notify completion
        run: |
          echo "================================================"
          echo "ğŸ‰ DEPLOYMENT COMPLETE"
          echo "================================================"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸŒ Sites:"
          echo "   - https://unclogged.me (EN)"
          echo "   - https://deboucheur.expert (FR)"
          echo "================================================"

  # ===========================================================================
  # JOB 6: Notify on Failure
  # ===========================================================================
  notify-failure:
    name: ğŸ“§ Notify Failure
    runs-on: ubuntu-latest
    needs: [validate, security, build, deploy]
    if: failure()
    
    steps:
      - name: ğŸš¨ Create failure summary
        run: |
          echo "================================================"
          echo "âŒ DEPLOYMENT FAILED"
          echo "================================================"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ” Check the Actions log for details"
          echo "================================================"
